<!doctype html>
<title>Living Meta Analysis</title>
<script src="https://apis.google.com/js/platform.js"></script>
<link rel="stylesheet" href="/css/main.css">

<h1>Living Meta Analysis main page</h1>

<!-- this puts a sign-in button, and a sign-out link, in the page -->
<div class="userinfo signedoff">
  <img src="/img/user.png" class="userphoto">
  <div class="actions">
    <div class="name whensignedon">Signed in as: <span class="username"></span></div>
    <div class="g-signin2 signin"></div>
    <a href="/profile" class="profile whensignedon">Profile</a>
    <a href="#" class="signout whensignedon">Sign out</a>
  </div>
</div>



<a href="/profile">your profile</a>

<p>top users:</p>
<ol class="topusers"><li value="0">none</li></ol>


<script src="/js/tools.js"></script>
<script src="/js/auth.js"></script>
<script>
window.limeta.initPage = function () {
  // todo this is provisional

  var limeta = window.limeta;
  var _ = limeta._;

  limeta.getGapiIDToken(function (err, idToken) {
    if (err) {
      console.err('can\'t load top users');
      console.err(err);
      return;
    }

    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/topusers');
    if (idToken) xhr.setRequestHeader("Authorization", "Bearer " + idToken);

    xhr.onload = showTopUsers;
    xhr.send();
  })

  function showTopUsers() {
    var xhr = this;
    if (xhr.status > 299) {
      limeta.apiFail();
      return;
    }
    var users = JSON.parse(xhr.responseText);
    var list = _.findEl('.topusers');
    list.innerHTML = '';

    users.forEach(function (user) {
      var li = document.createElement('li');
      var userlink = document.createElement('a');
      userlink.href = '/' + user.email + '/';
      userlink.textContent = user.displayName;
      li.appendChild(userlink);
      list.appendChild(li);
    });
  }
}

</script>
