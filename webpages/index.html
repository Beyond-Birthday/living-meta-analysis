<!doctype html>
<title>Living Meta Analysis</title>
<script src="/lib/promise.js"></script>
<script src="/lib/fetch.js"></script>
<script src="https://apis.google.com/js/platform.js"></script>
<link rel="stylesheet" href="/css/main.css">

<h1>Living Meta Analysis main page</h1>

<!-- this puts a sign-in button, and a sign-out link, in the page -->
<div class="userinfo signedoff">
  <img src="/img/user.png" class="userphoto">
  <div class="actions">
    <div class="name when-signed-on">Signed in as: <span class="username"></span></div>
    <div class="g-signin2 signin"></div>
    <a href="/profile/" class="profile when-signed-on">Profile</a>
    <a href="#" class="signout when-signed-on">Sign out</a>
  </div>
</div>



<a class="when-signed-on" href="/profile">your profile</a>

<p>top users:</p>
<ol class="topusers"><li value="0">none</li></ol>


<p>top metaanalyses:</p>
<ol class="topmetaanalyses"><li value="0">none</li></ol>


<p>top articles:</p>
<ol class="toparticles"><li value="0">none</li></ol>


<script src="/js/tools.js"></script>
<script src="/js/auth.js"></script>
<script>
window.limeta.initPage = function () {
  // todo this is provisional

  var limeta = window.limeta;
  var _ = limeta._;

  limeta.getGapiIDToken()
  .then(function (idToken) {
    return fetch('/api/topusers', _.idTokenToFetchOptions(idToken));
  })
  .then(_.fetchJson)
  .then(showTopUsers)
  .catch(function (err) {
    console.error('can\'t load top users');
    console.error(err);
    limeta.apiFail();
  });

  limeta.getGapiIDToken()
  .then(function (idToken) {
    return fetch('/api/toparticles', _.idTokenToFetchOptions(idToken));
  })
  .then(_.fetchJson)
  .then(showTopArticles)
  .catch(function (err) {
    console.error('can\'t load top articles');
    console.error(err);
    limeta.apiFail();
  });

  limeta.getGapiIDToken()
  .then(function (idToken) {
    return fetch('/api/topmetaanalyses', _.idTokenToFetchOptions(idToken));
  })
  .then(_.fetchJson)
  .then(showTopMetaanalyses)
  .catch(function (err) {
    console.error('can\'t load top metaanalyses');
    console.error(err);
    limeta.apiFail();
  });

  function showTopUsers(users) {
    var list = _.findEl('.topusers');
    list.innerHTML = '';

    users.forEach(function (user) {
      var li = document.createElement('li');
      var userlink = document.createElement('a');
      userlink.href = '/' + user.email + '/';
      userlink.textContent = user.displayName;
      li.appendChild(userlink);
      list.appendChild(li);
    });
  }

  function showTopMetaanalyses(metaanalyses) {
    var list = _.findEl('.topmetaanalyses');
    list.innerHTML = '';

    metaanalyses.forEach(function (metaanalysis) {
      var li = document.createElement('li');
      var metaanalysislink = document.createElement('a');
      metaanalysislink.href = '/' + metaanalysis.enteredBy + '/' + metaanalysis.title + '/';
      metaanalysislink.textContent = metaanalysis.title;
      li.appendChild(metaanalysislink);
      list.appendChild(li);
    });
  }

  function showTopArticles(articles) {
    var list = _.findEl('.toparticles');
    list.innerHTML = '';

    articles.forEach(function (article) {
      var li = document.createElement('li');
      var articlelink = document.createElement('a');
      articlelink.href = '/' + article.enteredBy + '/' + article.title + '/';
      articlelink.textContent = article.title;
      li.appendChild(articlelink);
      list.appendChild(li);
    });
  }
};

</script>
